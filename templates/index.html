{% extends "layout.html" %}

{% block title %}
  Hello World!
{% endblock %}

{% block content %}
  <style>
    section {
      height: calc(100vh - 52px);
      display: grid;
      grid-template-columns: minmax(200px, 1fr) 4fr;
    }
    aside {
      background-color: #abcdef;
      padding: 20px;
    }

    .menu-list button, #Chat-Name button {
      background-color: transparent;
      border: none;
      cursor: pointer;
    }

    #Menu-search-bar {
      padding: 8px 4px 8px 16px;
      margin-bottom: 0px;
    }

    .menu-input > .level-left {
      flex-grow: 1;
      flex-shrink: 1;
    }

    .menu-input .level-item {
      justify-content: flex-start;
      flex-grow: 1;
      flex-shrink: 1;
    }

    .menu-input input {
      border: none;
      width: 100%;
    }

    .menu-input button.is-rounded {
      height: 35px;
      width: 35px;
      padding: .1em .12em .1em .08em;
    }

    #Menu-search-bar button {
      padding: .5em;
      color: #9f9f9f;
    }

    #Menu-search-bar button:hover {
      background-color: transparent;
      color: #262626;
    }

    #Menu-Channels .menu-label {
      display: flex;
      justify-content: space-between;
    }
    main {
      padding: 1em;
      height: calc(100vh - 52px);
      background-color: #eee;
      display: flex; 
      flex-direction: column;
    }

    #Chat-Input {
      padding-right: .5em;
      margin: .5em 0;
    }

    #Chat-Send {
      padding: .5em .8em .5em .6em;
      font-size: 14px;
      margin-left: .25em;
    }

    #Chat-Name, #Chat-Input {
      min-height: 50px;
    }
    #Chat-Convo {
      flex-grow: 1;
      background-color: #ddd;
      overflow-y: auto;
    }
    #Chat-Convo > div {
      overflow-wrap: break-word;
      max-width: 75vw;
    }

    #Chat-Convo .box {
      padding: .5em;
      margin: .5em .5em 1em .5em;
      width: max-content;
    }

    #Chat-Convo .box:not(:last-child){
      margin-bottom: 1em;
    }

    #Chat-Convo .box.self-chat {
      margin-left: auto;
    }

    #Chat-Emoji .dropdown-content {
      display: grid;
      grid-template-columns: repeat(22, 1fr);
      height: 30vh;
      width: 75vw;
      overflow-y: auto;
      cursor: pointer;
    }
    #Chat-Emoji .dropdown.is-right .dropdown-menu {
      right: -50px;
    }

    #Chat-Emoji .dropdown-content > div {
      padding-left: auto;
      padding-right: auto;
      font-size: 20px;
    }

    @media screen and (max-width: 768px) {
      .level-left+.level-right {
        margin-top: 0rem;
      }
    }

    @media screen and (max-width: 900px) {
      section {
        grid-template-columns: 5fr;
      }
      aside {
        display:none;
      }

      .dropdown-content{
        grid-template-columns: repeat(10, 1fr);
        width: 98vw;
      }
    }
    @media screen and (max-width: 500px) {
      .dropdown-content{
        grid-template-columns: repeat(7, 1fr);
      }
    }



  </style>

<section>
  <!-- Channel Aside -->
  <aside class="menu">
    <!-- Search Bar -->
    <p class="menu-label">
      Channels
    </p>
    <ul class="menu-list" id="Menu-Channels">
      <li>
        <div class="input is-rounded level menu-input" id="Menu-search-bar">
          <div class="control is-expanded level-left">
            <div class="level-item">
              <input type="text" placeholder="Search or create channel" id="Menu-search-value" class="is-danger">
            </div>
          </div>
          <div class="control level-right">
            <div class="level-item">
              <button id="Menu-search-Add">
                <i class="fas fa-plus"></i>
              </button>
              <button id="Menu-search-Search">
                <i class="fas fa-search"></i>
              </button>
            </div>
          </div>
        </div>
        <p class="help is-danger"></p>
      </li> 
      <br>
      <div id="Menu-Channels-List" class="is-hidden">
        <p class="menu-label" >
          <span>Search Results</span>
          <button class="delete is-small"></button>
        </p>
        <div></div>
        <hr>
      </div> 
    </ul>

    <!-- My channels -->
    <p class="menu-label">
      My Channels
    </p>
    <ul class="menu-list">
      <div id="Menu-My-Channels-List">

      </div>  
    </ul>
    <p class="menu-label">
      Friends
    </p>
    <ul class="menu-list">
      <div id="Menu-My-Friends-List">

      </div>  
    </ul>
  </aside>
  <main>
    <!-- Main channel or last channel -->
    <div id="Chat-Name"></div>
    <div class="modal" id="Chat-Members">
      <div class="modal-background"></div>
      <div class="modal-card">
        <header class="modal-card-head">
          <p class="modal-card-title">Members</p>
          <button class="delete" aria-label="close"></button>
        </header>
        <section class="modal-card-body">
          
        </section>
      </div> 
    </div>  
    <div id="Chat-Convo"></div>
    <div id="Chat-Input" class="input is-rounded level menu-input">
      <div class="control is-expanded level-left">
        <div class="level-item">
          <input type="text" placeholder="Say something here!" onkeyup="messageInput()">
          <p class="help is-danger"></p>
        </div>
      </div>
      <div class="control level-right">
        <div class="level-item">
          <div class="dropdown is-right is-up" id="Chat-Emoji">
            <div class="dropdown-trigger">
              <button class="button is-rounded is-info" aria-haspopup="true" aria-controls="dropdown-menu" onclick="toggleEmoji()">
                  <i class="far fa-smile"></i>
              </button>
            </div>
            <div class="dropdown-menu" id="dropdown-menu" role="menu">
              <div class="dropdown-content">
              </div>
            </div>
          </div>
          
          <button class="button is-rounded is-info" id="Chat-Send" onclick="sendMessage()">
              <i class="fas fa-paper-plane"></i>
          </button>
        </div>
      </div>
    </div>
  </main>
</section>
  
<script id="Template-Username" type="text/x-lodash-template">
  <div>
    <%= comment %>
  </div>
</script>

<script id="Template-Modal" type="text/x-lodash-template">
  <div class="modal is-active" id="Index-PopUp">
    <div class="modal-background"></div>  
    <div class="modal-content">

      <div class="box">
        <article class="media">
          <div class="media-content">
            <div class="content">

              <p class="title is-3">Welcome to ChatRoom!</p>
              <p class="subtitle is-5">First time here? Enter username below to begin!</p>

              <div class="field">
                <label class="label">Name</label>
                <div class="control has-icons-left has-icons-right">
                  <input class="input" type="text" placeholder="Username">
                  <span class="icon is-small is-left">
                    <i class="fas fa-user"></i>
                  </span>
                  <p class="help is-danger"></p>
                </div>
              </div>

              <div class="buttons is-right">
                <div class="control">
                  <button class="button is-link">Submit</button>
                </div>
              </div>

            </div>
          </div>
        </article>
      </div>

    </div>
  </div>
</script>

  <script id="Template-Emoji" type="text/x-lodash-template">
    <div class="dropdown-item">
      <%= emoji %>
    </div>
  </script>

  <script>
      // The app will store the userNAME into localStorage
      // Upon running, the app will retrieve user details from server
        // AND STORE USER OBJECT into USER_STATE
        // to keep memory in sync

      // somehow storing nodes in variables will cause rendering errors

      const templateFn = _.template(document.querySelector("#Template-Username").innerHTML);
      const EmojiTemp = _.template(document.querySelector("#Template-Emoji").innerHTML);
      // const MemberTemp = _.template(document.querySelector("#Template-MemberModal").innerHTML);
      const channelContainer = document.querySelector("#Menu-Channels");

      const ChannelList = document.querySelector("#Menu-Channels-List > div");
      const MyChannelList = document.querySelector("#Menu-My-Channels-List");
      
      // https://cs50.harvard.edu/web/notes/5/
      const socket = io.connect(location.protocol + '//' + document.domain + ':' + location.port);

      document.addEventListener("DOMContentLoaded", function() {
      // USER VALIDATION
        // Returned users to be greeted
        if (storedUSERNAME) {
          // get User Object from server
          socket.emit("get user", storedUSERNAME);

          // server response
          socket.on("return user", userObj => {
            // Fallback in case of server problems
            if (userObj == "error") {
              // USER_STATE is updated inside the promise
              usernameModalManager(new User(new Date()));
                    
            } else {
              // Return userObj successful
              USER_STATE = userJSONConvert(userObj);

              document.querySelector("#Layout-Greeting").innerHTML = 
                templateFn({"comment": `Welcome back, ${USER_STATE.username}`});

              // TO BE REFACTORED
              // Channels attached to user are merely keys
              // Append the channels to sidebar
              
              if (USER_STATE.channels) {
                myChannels = USER_STATE.channels.filter(channelName => storedChannelName != channelName);

                console.log(myChannels, 269);

                if (myChannels.length) {
                  socket.emit("get channels", myChannels);
                }
              } 
            }
          });
        } else {
          // If first time, get unique username

          // new User Object
          // USER_STATE is updated inside the promise
          usernameModalManager(new User(new Date()));
        }

      // CHANNEL FUNCTIONALITIES
        // everytime a channel is shown
          // CHANNEL_STATE and localStorage will be updated
          // but it might not be added to USER_STATE
          // therefore it would be safer to render the 2 separately

        // Main window
        // Render only the screen 
        if (!storedChannelName) {
          let helpfulMsg = document.createElement("li");
            helpfulMsg.append("Click search to view full list of public channels!");

          MyChannelList.append(helpfulMsg);

          document.querySelector("#Chat-Name").textContent = "Welcome!";
          document.querySelector("#Chat-Convo").innerHTML = templateFn({"comment": 
            "Start by searching a channel to join or create one yourself!"});
        } else {
          socket.emit("get last channel", storedChannelName);

          socket.on("last channel", channel => {
            if (channel) {
              channel = channelJSONConvert(channel);
              let privateFriendChat = channel.name.split("%%").length == 3;

              if (privateFriendChat) {
                document.querySelector("#Menu-My-Friends-List").append(channel.showChatList(privateFriendChat));
              } else {
                // It is possible that user clicked on a channel
                  // but did not add channel to USER_OBJECT
                if (USER_STATE.channels.includes(channel.name)) {
                  MyChannelList.append(channel.showChatList());
                }
              }
              channel.showChat(privateFriendChat);
            } else {
              // server error or reset
              // in this branch CHANNEL_STATE is still not defined
              console.error("error 295 server error");
              localStorage.removeItem("channel");
              alert("Oh no! Something has went wrong! Please refresh the page!");

              document.querySelector("#Chat-Convo").innerHTML = 
                templateFn({"comment": 
                  "Start by searching a channel to join or create one yourself!"});
            }
          });
        }
      });
      // Onload event end
              
      socket.on("channel results", channelResults => {
        if (channelResults) {
          channelResults.forEach(channel => 
            MyChannelList.append(
              channelJSONConvert(channel).showChatList()
            )
          );
        } else {
          // server problem
          let helpfulMsg = document.createElement("li");
          helpfulMsg.append("Search for channels above!");

          MyChannelList.append(helpfulMsg);
        }
      });

      // Channel Functionalities

        // Create Channel
        const createChannel = document.querySelector("#Menu-search-Add");
        const searchChannel = document.querySelector("#Menu-search-Search");
        let searchBarValue;

        createChannel.addEventListener("click", function(event){
          event.preventDefault();
          SearchBarWarning(false);

          searchBarValue = document.querySelector("#Menu-search-value").value;

          if (searchBarValue) {
            // Check whether channel name used
            socket.emit("new channel attempt", searchBarValue); // Raw unvalidated string
          }
        });

        // Manages creation of both public and private channels
        socket.on("channel create", function([channelCreateResult, channelName, visibility]) {
          let privateFriendChat = channelName.split("%%").length == 3;

          if (channelCreateResult) {
            let channel;
            
            if (!USER_STATE.channels.length) {
              MyChannelList.textContent = "";
            }
            
            if (privateFriendChat) { // indicate that this is a 1v1 convo
              channel = new Channel(channelName, USER_STATE.username, visibility);
              channelName.split("%%").forEach(friend => channel.addUser(friend));
            } else { // public and private group chat
              channel = new Channel(channelName, USER_STATE.username, visibility);
              channel.addUser(USER_STATE.username);
            }

            // set CHANNEL_STATE and localStorage
            if (privateFriendChat) {
              document.querySelector("#Menu-My-Friends-List").append(channel.showChatList(privateFriendChat));
            } else {
              MyChannelList.append(channel.showChatList());
            }
            channel.showChat(privateFriendChat);

            // announce to server on the creation
            socket.emit("new channel", JSON.stringify(CHANNEL_STATE));

            // and for User object
            USER_STATE.addChannel(CHANNEL_STATE);

            // reset box
            document.querySelector("#Menu-search-value").value = "";

          } else {
            // Channel Name used
            
            if (privateFriendChat) {
              socket.emit("get last channel", channelName);
            } else {
              if (visibility) {
              
                SearchBarWarning(true, "Name used!");

                setTimeout(() => {SearchBarWarning(false);}, 5000);
              } else {

              }
            }
          }
        });

        // Search channels
        searchChannel.addEventListener("click", function(event){
          event.preventDefault();
          console.log("search, 375")

          searchBarValue = document.querySelector("#Menu-search-value").value;

          // get all channels if no string
          socket.emit("search channels", searchBarValue); // Search String
          document.querySelector("#Menu-search-value").value = "";
        });

        socket.on("channel search result", channelSearchResult => {
          if (ChannelList.textContent) {
            ChannelList.textContent = "";
          }

          if (channelSearchResult) {
            document.querySelector("#Menu-Channels-List").classList.toggle("is-hidden");
            channelSearchResult.forEach(channelSearchItem => 
              ChannelList.append(
                channelJSONConvert(channelSearchItem).showChatList()
              )
            );
          } else {
            SearchBarWarning(true, "No result found!");
          }
        });

        document.querySelector("#Menu-Channels-List button")
          .addEventListener("click", function(event) {
            event.preventDefault();

            document.querySelector("#Menu-Channels-List").classList.toggle("is-hidden");
          }
        );
      

      // Messaging Functionalities
        
        // Emoji
        let emojis = ["&#x1F600;","&#x1F603;","&#x1F604;","&#x1F601;","&#x1F606;","&#x1F605;",
        "&#x1F923;","&#x1F602;","&#x1F642;","&#x1F643;","&#x1F609;","&#x1F60A;","&#x1F607;",
        "&#x1F970;","&#x1F60D;","&#x1F929;","&#x1F618;","&#x1F617;","&#x263A;","&#x1F61A;",
        "&#x1F619;","&#x1F60B;","&#x1F61B;","&#x1F61C;","&#x1F92A;","&#x1F61D;","&#x1F911;",
        "&#x1F917;","&#x1F92D;","&#x1F92B;","&#x1F914;","&#x1F910;","&#x1F928;","&#x1F610;",
        "&#x1F611;","&#x1F636;","&#x1F60F;","&#x1F612;","&#x1F644;","&#x1F62C;","&#x1F925;",
        "&#x1F60C;","&#x1F614;","&#x1F62A;","&#x1F924;","&#x1F634;","&#x1F637;","&#x1F912;",
        "&#x1F915;","&#x1F922;","&#x1F92E;","&#x1F927;","&#x1F975;","&#x1F976;","&#x1F974;",
        "&#x1F635;","&#x1F92F;","&#x1F920;","&#x1F973;","&#x1F60E;","&#x1F913;","&#x1F9D0;",
        "&#x1F615;","&#x1F61F;","&#x1F641;","&#x2639;","&#x1F62E;","&#x1F62F;","&#x1F632;",
        "&#x1F633;","&#x1F97A;","&#x1F626;","&#x1F627;","&#x1F628;","&#x1F630;","&#x1F625;",
        "&#x1F622;","&#x1F62D;","&#x1F631;","&#x1F616;","&#x1F623;","&#x1F61E;","&#x1F613;",
        "&#x1F629;","&#x1F62B;","&#x1F971;","&#x1F624;","&#x1F621;","&#x1F620;","&#x1F92C;",
        "&#x1F608;","&#x1F47F;","&#x1F480;","&#x2620;","&#x1F4A9;","&#x1F921;","&#x1F479;",
        "&#x1F47A;","&#x1F47B;","&#x1F47D;","&#x1F47E;","&#x1F916;","&#x1F63A;","&#x1F638;",
        "&#x1F639;","&#x1F63B;","&#x1F63C;","&#x1F63D;","&#x1F640;","&#x1F63F;","&#x1F63E;",
        "&#x1F648;","&#x1F649;","&#x1F64A;","&#x1F48B;","&#x1F48C;","&#x1F498;","&#x1F49D;",
        "&#x1F496;","&#x1F497;","&#x1F493;","&#x1F49E;","&#x1F495;","&#x1F49F;","&#x2763;",
        "&#x1F494;","&#x2764;","&#x1F9E1;","&#x1F49B;","&#x1F49A;","&#x1F499;","&#x1F49C;",
        "&#x1F90E;","&#x1F5A4;","&#x1F90D;","&#x1F4AF;","&#x1F4A2;","&#x1F4A5;","&#x1F4AB;",
        "&#x1F4A6;","&#x1F4A8;","&#x1F573;","&#x1F4A3;","&#x1F4AC;","&#x1F441;","&#x1F5E8;",
        "&#x1F5EF;","&#x1F4AD;","&#x1F4A4;","&#x1F44B;","&#x1F91A;","&#x1F590;","&#x270B;",
        "&#x1F596;","&#x1F44C;","&#x1F90F;","&#x270C;","&#x1F91E;","&#x1F91F;","&#x1F918;",
        "&#x1F919;","&#x1F448;","&#x1F449;","&#x1F446;","&#x1F595;","&#x1F447;","&#x261D;",
        "&#x1F44D;","&#x1F44E;","&#x270A;","&#x1F44A;","&#x1F91B;","&#x1F91C;","&#x1F44F;",
        "&#x1F64C;","&#x1F450;","&#x1F932;","&#x1F91D;","&#x1F64F;","&#x270D;","&#x1F485;",
        "&#x1F933;","&#x1F4AA;","&#x1F9BE;","&#x1F9BF;","&#x1F9B5;","&#x1F9B6;","&#x1F442;",
        "&#x1F9BB;","&#x1F443;","&#x1F9E0;","&#x1F9B7;","&#x1F9B4;","&#x1F440;","&#x1F445;",
        "&#x1F444;","&#x1F476;","&#x1F9D2;","&#x1F466;","&#x1F467;","&#x1F9D1;","&#x1F471;",
        "&#x1F468;","&#x1F9D4;","&#x1F469;","&#x1F9D3;","&#x1F474;","&#x1F475;","&#x1F64D;",
        "&#x1F64E;","&#x1F645;","&#x1F646;","&#x1F481;","&#x1F64B;","&#x1F9CF;","&#x1F647;",
        "&#x1F926;","&#x1F937;","&#x1F46E;","&#x1F575;","&#x1F482;","&#x1F477;","&#x1F934;",
        "&#x1F478;","&#x1F473;","&#x1F472;","&#x1F9D5;","&#x1F935;","&#x1F470;","&#x1F930;",
        "&#x1F931;","&#x1F47C;","&#x1F385;","&#x1F936;","&#x1F9B8;","&#x1F9B9;","&#x1F9D9;",
        "&#x1F9DA;","&#x1F9DB;","&#x1F9DC;","&#x1F9DD;","&#x1F9DE;","&#x1F9DF;","&#x1F486;",
        "&#x1F487;","&#x1F6B6;","&#x1F9CD;","&#x1F9CE;","&#x1F3C3;","&#x1F483;","&#x1F57A;",
        "&#x1F574;","&#x1F46F;","&#x1F9D6;","&#x1F9D7;","&#x1F93A;","&#x1F3C7;","&#x26F7;",
        "&#x1F3C2;","&#x1F3CC;","&#x1F3C4;","&#x1F6A3;","&#x1F3CA;","&#x26F9;","&#x1F3CB;",
        "&#x1F6B4;","&#x1F6B5;","&#x1F938;","&#x1F93C;","&#x1F93D;","&#x1F93E;","&#x1F939;",
        "&#x1F9D8;","&#x1F6C0;","&#x1F6CC;","&#x1F46D;","&#x1F46B;","&#x1F46C;","&#x1F48F;",
        "&#x1F491;","&#x1F46A;","&#x1F5E3;","&#x1F464;","&#x1F465;","&#x1F463;","&#x1F9B0;",
        "&#x1F9B1;","&#x1F9B3;","&#x1F9B2;","&#x1F435;","&#x1F412;","&#x1F98D;","&#x1F9A7;",
        "&#x1F436;","&#x1F415;","&#x1F9AE;","&#x1F429;","&#x1F43A;","&#x1F98A;","&#x1F99D;",
        "&#x1F431;","&#x1F408;","&#x1F981;","&#x1F42F;","&#x1F405;","&#x1F406;","&#x1F434;",
        "&#x1F40E;","&#x1F984;","&#x1F993;","&#x1F98C;","&#x1F42E;","&#x1F402;","&#x1F403;",
        "&#x1F404;","&#x1F437;","&#x1F416;","&#x1F417;","&#x1F43D;","&#x1F40F;","&#x1F411;",
        "&#x1F410;","&#x1F42A;","&#x1F42B;","&#x1F999;","&#x1F992;","&#x1F418;","&#x1F98F;",
        "&#x1F99B;","&#x1F42D;","&#x1F401;","&#x1F400;","&#x1F439;","&#x1F430;","&#x1F407;",
        "&#x1F43F;","&#x1F994;","&#x1F987;","&#x1F43B;","&#x1F428;","&#x1F43C;","&#x1F9A5;",
        "&#x1F9A6;","&#x1F9A8;","&#x1F998;","&#x1F9A1;","&#x1F43E;","&#x1F983;","&#x1F414;",
        "&#x1F413;","&#x1F423;","&#x1F424;","&#x1F425;","&#x1F426;","&#x1F427;","&#x1F54A;",
        "&#x1F985;","&#x1F986;","&#x1F9A2;","&#x1F989;","&#x1F9A9;","&#x1F99A;","&#x1F99C;",
        "&#x1F438;","&#x1F40A;","&#x1F422;","&#x1F98E;","&#x1F40D;","&#x1F432;","&#x1F409;",
        "&#x1F995;","&#x1F996;","&#x1F433;","&#x1F40B;","&#x1F42C;","&#x1F41F;","&#x1F420;",
        "&#x1F421;","&#x1F988;","&#x1F419;","&#x1F41A;","&#x1F40C;","&#x1F98B;","&#x1F41B;",
        "&#x1F41C;","&#x1F41D;","&#x1F41E;","&#x1F997;","&#x1F577;","&#x1F578;","&#x1F982;",
        "&#x1F99F;","&#x1F9A0;","&#x1F490;","&#x1F338;","&#x1F4AE;","&#x1F3F5;","&#x1F339;",
        "&#x1F940;","&#x1F33A;","&#x1F33B;","&#x1F33C;","&#x1F337;","&#x1F331;","&#x1F332;",
        "&#x1F333;","&#x1F334;","&#x1F335;","&#x1F33E;","&#x1F33F;","&#x2618;","&#x1F340;",
        "&#x1F341;","&#x1F342;","&#x1F343;","&#x1F347;","&#x1F348;","&#x1F349;","&#x1F34A;",
        "&#x1F34B;","&#x1F34C;","&#x1F34D;","&#x1F96D;","&#x1F34E;","&#x1F34F;","&#x1F350;",
        "&#x1F351;","&#x1F352;","&#x1F353;","&#x1F95D;","&#x1F345;","&#x1F965;","&#x1F951;",
        "&#x1F346;","&#x1F954;","&#x1F955;","&#x1F33D;","&#x1F336;","&#x1F952;","&#x1F96C;",
        "&#x1F966;","&#x1F9C4;","&#x1F9C5;","&#x1F344;","&#x1F95C;","&#x1F330;","&#x1F35E;",
        "&#x1F950;","&#x1F956;","&#x1F968;","&#x1F96F;","&#x1F95E;","&#x1F9C7;","&#x1F9C0;",
        "&#x1F356;","&#x1F357;","&#x1F969;","&#x1F953;","&#x1F354;","&#x1F35F;","&#x1F355;",
        "&#x1F32D;","&#x1F96A;","&#x1F32E;","&#x1F32F;","&#x1F959;","&#x1F9C6;","&#x1F95A;",
        "&#x1F373;","&#x1F958;","&#x1F372;","&#x1F963;","&#x1F957;","&#x1F37F;","&#x1F9C8;",
        "&#x1F9C2;","&#x1F96B;","&#x1F371;","&#x1F358;","&#x1F359;","&#x1F35A;","&#x1F35B;",
        "&#x1F35C;","&#x1F35D;","&#x1F360;","&#x1F362;","&#x1F363;","&#x1F364;","&#x1F365;",
        "&#x1F96E;","&#x1F361;","&#x1F95F;","&#x1F960;","&#x1F961;","&#x1F980;","&#x1F99E;",
        "&#x1F990;","&#x1F991;","&#x1F9AA;","&#x1F366;","&#x1F367;","&#x1F368;","&#x1F369;",
        "&#x1F36A;","&#x1F382;","&#x1F370;","&#x1F9C1;","&#x1F967;","&#x1F36B;","&#x1F36C;",
        "&#x1F36D;","&#x1F36E;","&#x1F36F;","&#x1F37C;","&#x1F95B;","&#x2615;","&#x1F375;",
        "&#x1F376;","&#x1F37E;","&#x1F377;","&#x1F378;","&#x1F379;","&#x1F37A;","&#x1F37B;",
        "&#x1F942;","&#x1F943;","&#x1F964;","&#x1F9C3;","&#x1F9C9;","&#x1F9CA;","&#x1F962;",
        "&#x1F37D;","&#x1F374;","&#x1F944;","&#x1F52A;","&#x1F3FA;","&#x1F30D;","&#x1F30E;",
        "&#x1F30F;","&#x1F310;","&#x1F5FA;","&#x1F5FE;","&#x1F9ED;","&#x1F3D4;","&#x26F0;",
        "&#x1F30B;","&#x1F5FB;","&#x1F3D5;","&#x1F3D6;","&#x1F3DC;","&#x1F3DD;","&#x1F3DE;",
        "&#x1F3DF;","&#x1F3DB;","&#x1F3D7;","&#x1F9F1;","&#x1F3D8;","&#x1F3DA;","&#x1F3E0;",
        "&#x1F3E1;","&#x1F3E2;","&#x1F3E3;","&#x1F3E4;","&#x1F3E5;","&#x1F3E6;","&#x1F3E8;",
        "&#x1F3E9;","&#x1F3EA;","&#x1F3EB;","&#x1F3EC;","&#x1F3ED;","&#x1F3EF;","&#x1F3F0;",
        "&#x1F492;","&#x1F5FC;","&#x1F5FD;","&#x26EA;","&#x1F54C;","&#x1F6D5;","&#x1F54D;",
        "&#x26E9;","&#x1F54B;","&#x26F2;","&#x26FA;","&#x1F301;","&#x1F303;","&#x1F3D9;",
        "&#x1F304;","&#x1F305;","&#x1F306;","&#x1F307;","&#x1F309;","&#x2668;","&#x1F3A0;",
        "&#x1F3A1;","&#x1F3A2;","&#x1F488;","&#x1F3AA;","&#x1F682;","&#x1F683;","&#x1F684;",
        "&#x1F685;","&#x1F686;","&#x1F687;","&#x1F688;","&#x1F689;","&#x1F68A;","&#x1F69D;",
        "&#x1F69E;","&#x1F68B;","&#x1F68C;","&#x1F68D;","&#x1F68E;","&#x1F690;","&#x1F691;",
        "&#x1F692;","&#x1F693;","&#x1F694;","&#x1F695;","&#x1F696;","&#x1F697;","&#x1F698;",
        "&#x1F699;","&#x1F69A;","&#x1F69B;","&#x1F69C;","&#x1F3CE;","&#x1F3CD;","&#x1F6F5;",
        "&#x1F9BD;","&#x1F9BC;","&#x1F6FA;","&#x1F6B2;","&#x1F6F4;","&#x1F6F9;","&#x1F68F;",
        "&#x1F6E3;","&#x1F6E4;","&#x1F6E2;","&#x26FD;","&#x1F6A8;","&#x1F6A5;","&#x1F6A6;",
        "&#x1F6D1;","&#x1F6A7;","&#x2693;","&#x26F5;","&#x1F6F6;","&#x1F6A4;","&#x1F6F3;",
        "&#x26F4;","&#x1F6E5;","&#x1F6A2;","&#x2708;","&#x1F6E9;","&#x1F6EB;","&#x1F6EC;",
        "&#x1FA82;","&#x1F4BA;","&#x1F681;","&#x1F69F;","&#x1F6A0;","&#x1F6A1;","&#x1F6F0;",
        "&#x1F680;","&#x1F6F8;","&#x1F6CE;","&#x1F9F3;","&#x231B;","&#x23F3;","&#x231A;",
        "&#x23F0;","&#x23F1;","&#x23F2;","&#x1F570;","&#x1F55B;","&#x1F567;","&#x1F550;",
        "&#x1F55C;","&#x1F551;","&#x1F55D;","&#x1F552;","&#x1F55E;","&#x1F553;","&#x1F55F;",
        "&#x1F554;","&#x1F560;","&#x1F555;","&#x1F561;","&#x1F556;","&#x1F562;","&#x1F557;",
        "&#x1F563;","&#x1F558;","&#x1F564;","&#x1F559;","&#x1F565;","&#x1F55A;","&#x1F566;",
        "&#x1F311;","&#x1F312;","&#x1F313;","&#x1F314;","&#x1F315;","&#x1F316;","&#x1F317;",
        "&#x1F318;","&#x1F319;","&#x1F31A;","&#x1F31B;","&#x1F31C;","&#x1F321;","&#x2600;",
        "&#x1F31D;","&#x1F31E;","&#x1FA90;","&#x2B50;","&#x1F31F;","&#x1F320;","&#x1F30C;",
        "&#x2601;","&#x26C5;","&#x26C8;","&#x1F324;","&#x1F325;","&#x1F326;","&#x1F327;",
        "&#x1F328;","&#x1F329;","&#x1F32A;","&#x1F32B;","&#x1F32C;","&#x1F300;","&#x1F308;",
        "&#x1F302;","&#x2602;","&#x2614;","&#x26F1;","&#x26A1;","&#x2744;","&#x2603;","&#x26C4;",
        "&#x2604;","&#x1F525;","&#x1F4A7;","&#x1F30A;","&#x1F383;","&#x1F384;","&#x1F386;",
        "&#x1F387;","&#x1F9E8;","&#x2728;","&#x1F388;","&#x1F389;","&#x1F38A;","&#x1F38B;",
        "&#x1F38D;","&#x1F38E;","&#x1F38F;","&#x1F390;","&#x1F391;","&#x1F9E7;","&#x1F380;",
        "&#x1F381;","&#x1F397;","&#x1F39F;","&#x1F3AB;","&#x1F396;","&#x1F3C6;","&#x1F3C5;",
        "&#x1F947;","&#x1F948;","&#x1F949;","&#x26BD;","&#x26BE;","&#x1F94E;","&#x1F3C0;",
        "&#x1F3D0;","&#x1F3C8;","&#x1F3C9;","&#x1F3BE;","&#x1F94F;","&#x1F3B3;","&#x1F3CF;",
        "&#x1F3D1;","&#x1F3D2;","&#x1F94D;","&#x1F3D3;","&#x1F3F8;","&#x1F94A;","&#x1F94B;",
        "&#x1F945;","&#x26F3;","&#x26F8;","&#x1F3A3;","&#x1F93F;","&#x1F3BD;","&#x1F3BF;",
        "&#x1F6F7;","&#x1F94C;","&#x1F3AF;","&#x1FA80;","&#x1FA81;","&#x1F3B1;","&#x1F52E;",
        "&#x1F9FF;","&#x1F3AE;","&#x1F579;","&#x1F3B0;","&#x1F3B2;","&#x1F9E9;","&#x1F9F8;",
        "&#x2660;","&#x2665;","&#x2666;","&#x2663;","&#x265F;","&#x1F0CF;","&#x1F004;","&#x1F3B4;",
        "&#x1F3AD;","&#x1F5BC;","&#x1F3A8;","&#x1F9F5;","&#x1F9F6;","&#x1F453;","&#x1F576;",
        "&#x1F97D;","&#x1F97C;","&#x1F9BA;","&#x1F454;","&#x1F455;","&#x1F456;","&#x1F9E3;",
        "&#x1F9E4;","&#x1F9E5;","&#x1F9E6;","&#x1F457;","&#x1F458;","&#x1F97B;","&#x1FA71;",
        "&#x1FA72;","&#x1FA73;","&#x1F459;","&#x1F45A;","&#x1F45B;","&#x1F45C;","&#x1F45D;",
        "&#x1F6CD;","&#x1F392;","&#x1F45E;","&#x1F45F;","&#x1F97E;","&#x1F97F;","&#x1F460;",
        "&#x1F461;","&#x1FA70;","&#x1F462;","&#x1F451;","&#x1F452;","&#x1F3A9;","&#x1F393;",
        "&#x1F9E2;","&#x26D1;","&#x1F4FF;","&#x1F484;","&#x1F48D;","&#x1F48E;","&#x1F507;",
        "&#x1F508;","&#x1F509;","&#x1F50A;","&#x1F4E2;","&#x1F4E3;","&#x1F4EF;","&#x1F514;",
        "&#x1F515;","&#x1F3BC;","&#x1F3B5;","&#x1F3B6;","&#x1F399;","&#x1F39A;","&#x1F39B;",
        "&#x1F3A4;","&#x1F3A7;","&#x1F4FB;","&#x1F3B7;","&#x1F3B8;","&#x1F3B9;","&#x1F3BA;",
        "&#x1F3BB;","&#x1FA95;","&#x1F941;","&#x1F4F1;","&#x1F4F2;","&#x260E;","&#x1F4DE;",
        "&#x1F4DF;","&#x1F4E0;","&#x1F50B;","&#x1F50C;","&#x1F4BB;","&#x1F5A5;","&#x1F5A8;",
        "&#x2328;","&#x1F5B1;","&#x1F5B2;","&#x1F4BD;","&#x1F4BE;","&#x1F4BF;","&#x1F4C0;",
        "&#x1F9EE;","&#x1F3A5;","&#x1F39E;","&#x1F4FD;","&#x1F3AC;","&#x1F4FA;","&#x1F4F7;",
        "&#x1F4F8;","&#x1F4F9;","&#x1F4FC;","&#x1F50D;","&#x1F50E;","&#x1F56F;","&#x1F4A1;",
        "&#x1F526;","&#x1F3EE;","&#x1FA94;","&#x1F4D4;","&#x1F4D5;","&#x1F4D6;","&#x1F4D7;",
        "&#x1F4D8;","&#x1F4D9;","&#x1F4DA;","&#x1F4D3;","&#x1F4D2;","&#x1F4C3;","&#x1F4DC;",
        "&#x1F4C4;","&#x1F4F0;","&#x1F5DE;","&#x1F4D1;","&#x1F516;","&#x1F3F7;","&#x1F4B0;",
        "&#x1F4B4;","&#x1F4B5;","&#x1F4B6;","&#x1F4B7;","&#x1F4B8;","&#x1F4B3;","&#x1F9FE;",
        "&#x1F4B9;","&#x1F4B1;","&#x1F4B2;","&#x2709;","&#x1F4E7;","&#x1F4E8;","&#x1F4E9;",
        "&#x1F4E4;","&#x1F4E5;","&#x1F4E6;","&#x1F4EB;","&#x1F4EA;","&#x1F4EC;","&#x1F4ED;",
        "&#x1F4EE;","&#x1F5F3;","&#x270F;","&#x2712;","&#x1F58B;","&#x1F58A;","&#x1F58C;",
        "&#x1F58D;","&#x1F4DD;","&#x1F4BC;","&#x1F4C1;","&#x1F4C2;","&#x1F5C2;","&#x1F4C5;",
        "&#x1F4C6;","&#x1F5D2;","&#x1F5D3;","&#x1F4C7;","&#x1F4C8;","&#x1F4C9;","&#x1F4CA;",
        "&#x1F4CB;","&#x1F4CC;","&#x1F4CD;","&#x1F4CE;","&#x1F587;","&#x1F4CF;","&#x1F4D0;",
        "&#x2702;","&#x1F5C3;","&#x1F5C4;","&#x1F5D1;","&#x1F512;","&#x1F513;","&#x1F50F;",
        "&#x1F510;","&#x1F511;","&#x1F5DD;","&#x1F528;","&#x1FA93;","&#x26CF;","&#x2692;",
        "&#x1F6E0;","&#x1F5E1;","&#x2694;","&#x1F52B;","&#x1F3F9;","&#x1F6E1;","&#x1F527;",
        "&#x1F529;","&#x2699;","&#x1F5DC;","&#x2696;","&#x1F9AF;","&#x1F517;","&#x26D3;",
        "&#x1F9F0;","&#x1F9F2;","&#x2697;","&#x1F9EA;","&#x1F9EB;","&#x1F9EC;","&#x1F52C;",
        "&#x1F52D;","&#x1F4E1;","&#x1F489;","&#x1FA78;","&#x1F48A;","&#x1FA79;","&#x1FA7A;",
        "&#x1F6AA;","&#x1F6CF;","&#x1F6CB;","&#x1FA91;","&#x1F6BD;","&#x1F6BF;","&#x1F6C1;",
        "&#x1FA92;","&#x1F9F4;","&#x1F9F7;","&#x1F9F9;","&#x1F9FA;","&#x1F9FB;","&#x1F9FC;",
        "&#x1F9FD;","&#x1F9EF;","&#x1F6D2;","&#x1F6AC;","&#x26B0;","&#x26B1;","&#x1F5FF;",
        "&#x1F3E7;","&#x1F6AE;","&#x1F6B0;","&#x267F;","&#x1F6B9;","&#x1F6BA;","&#x1F6BB;",
        "&#x1F6BC;","&#x1F6BE;","&#x1F6C2;","&#x1F6C3;","&#x1F6C4;","&#x1F6C5;","&#x26A0;",
        "&#x1F6B8;","&#x26D4;","&#x1F6AB;","&#x1F6B3;","&#x1F6AD;","&#x1F6AF;","&#x1F6B1;",
        "&#x1F6B7;","&#x1F4F5;","&#x1F51E;","&#x2622;","&#x2623;","&#x2B06;","&#x2197;",
        "&#x27A1;","&#x2198;","&#x2B07;","&#x2199;","&#x2B05;","&#x2196;","&#x2195;","&#x2194;",
        "&#x21A9;","&#x21AA;","&#x2934;","&#x2935;","&#x1F503;","&#x1F504;","&#x1F519;",
        "&#x1F51A;","&#x1F51B;","&#x1F51C;","&#x1F51D;","&#x1F6D0;","&#x269B;","&#x1F549;",
        "&#x2721;","&#x2638;","&#x262F;","&#x271D;","&#x2626;","&#x262A;","&#x262E;","&#x1F54E;",
        "&#x1F52F;","&#x2648;","&#x2649;","&#x264A;","&#x264B;","&#x264C;","&#x264D;","&#x264E;",
        "&#x264F;","&#x2650;","&#x2651;","&#x2652;","&#x2653;","&#x26CE;","&#x1F500;","&#x1F501;",
        "&#x1F502;","&#x25B6;","&#x23E9;","&#x23ED;","&#x23EF;","&#x25C0;","&#x23EA;","&#x23EE;",
        "&#x1F53C;","&#x23EB;","&#x1F53D;","&#x23EC;","&#x23F8;","&#x23F9;","&#x23FA;","&#x23CF;",
        "&#x1F3A6;","&#x1F505;","&#x1F506;","&#x1F4F6;","&#x1F4F3;","&#x1F4F4;","&#x2640;",
        "&#x2642;","&#x2695;","&#x267E;","&#x267B;","&#x269C;","&#x1F531;","&#x1F4DB;","&#x1F530;",
        "&#x2B55;","&#x2705;","&#x2611;","&#x2714;","&#x2716;","&#x274C;","&#x274E;","&#x2795;",
        "&#x2796;","&#x2797;","&#x27B0;","&#x27BF;","&#x303D;","&#x2733;","&#x2734;","&#x2747;",
        "&#x203C;","&#x2049;","&#x2753;","&#x2754;","&#x2755;","&#x2757;","&#x3030;","&#xA9;",
        "&#xAE;","&#x2122;","&#xFE0F;","&#x1F51F;","&#x1F520;","&#x1F521;","&#x1F522;","&#x1F523;",
        "&#x1F524;","&#x1F170;","&#x1F18E;","&#x1F171;","&#x1F191;","&#x1F192;","&#x1F193;",
        "&#x2139;","&#x1F194;","&#x24C2;","&#x1F195;","&#x1F196;","&#x1F17E;","&#x1F197;",
        "&#x1F17F;","&#x1F198;","&#x1F199;","&#x1F19A;","&#x1F201;","&#x1F202;","&#x1F237;",
        "&#x1F236;","&#x1F22F;","&#x1F250;","&#x1F239;","&#x1F21A;","&#x1F232;","&#x1F251;",
        "&#x1F238;","&#x1F234;","&#x1F233;","&#x3297;","&#x3299;","&#x1F23A;","&#x1F235;",
        "&#x1F534;","&#x1F7E0;","&#x1F7E1;","&#x1F7E2;","&#x1F535;","&#x1F7E3;","&#x1F7E4;",
        "&#x26AB;","&#x26AA;","&#x1F7E5;","&#x1F7E7;","&#x1F7E8;","&#x1F7E9;","&#x1F7E6;",
        "&#x1F7EA;","&#x1F7EB;","&#x2B1B;","&#x2B1C;","&#x25FC;","&#x25FB;","&#x25FE;","&#x25FD;",
        "&#x25AA;","&#x25AB;","&#x1F536;","&#x1F537;","&#x1F538;","&#x1F539;","&#x1F53A;",
        "&#x1F53B;","&#x1F4A0;","&#x1F518;","&#x1F533;","&#x1F532;","&#x1F3C1;","&#x1F6A9;",
        "&#x1F38C;","&#x1F3F4;","&#x1F3F3;","&#x1F1E6;","&#x1F1E7;","&#x1F1E8;","&#x1F1E9;",
        "&#x1F1EA;","&#x1F1EB;","&#x1F1EC;","&#x1F1ED;","&#x1F1EE;","&#x1F1EF;","&#x1F1F0;",
        "&#x1F1F1;","&#x1F1F2;","&#x1F1F3;","&#x1F1F4;","&#x1F1F5;","&#x1F1F6;","&#x1F1F7;",
        "&#x1F1F8;","&#x1F1F9;","&#x1F1FA;","&#x1F1FB;","&#x1F1FC;","&#x1F1FD;","&#x1F1FE;",
        "&#x1F1FF;"];
        
        document.querySelector("#Chat-Emoji .dropdown-content").innerHTML = 
          emojis.map(emoji => EmojiTemp({"emoji": emoji})).join("");

        document.querySelectorAll("#Chat-Emoji .dropdown-item")
          .forEach(node => node.addEventListener("click", function(event) {
            document.querySelector("#Chat-Input input").value += event.target.textContent.trim();
          }
        ));
        
        function toggleEmoji() {
          document.querySelector("#Chat-Emoji").addEventListener("click", function(event) {
            this.classList.toggle("is-active");
          });
        }
      
        // Message in
        socket.on('message in', messageParcel => {
          if (messageParcel.channel == CHANNEL_STATE.name) {
            messageParcel.message = unescape(messageParcel.message);
            let date = messageParcel.timeStamp;
            date = new Date(messageParcel.timeStamp.slice(8));

            if (document.querySelector("#Chat-Convo").innerHTML == "There is no message to be displayed. Start chatting!") {
              document.querySelector("#Chat-Convo").innerHTML = "";
            }
                        
            document.querySelector("#Chat-Convo").innerHTML += 
            `<div class="box ${messageParcel.author == USER_STATE.username ? "self-chat" : ""}">
                <p>${messageParcel.author} <span class="is-size-7 has-text-grey-light">at ${new Date().getDate() == date.getDate() ? messageParcel.timeStamp.slice(0,7) :  + messageParcel.timeStamp}</span></p>
                <div>${messageParcel.message}</div>
              </div>`;
            if (!CHANNEL_STATE.participants.includes(messageParcel.author)) {
              console.log(CHANNEL_STATE,753);
              CHANNEL_STATE.addUser(messageParcel.author);
              console.log(CHANNEL_STATE,755);
              socket.emit("update channel", JSON.stringify(CHANNEL_STATE));
              document.querySelector("#Chat-Name button").textContent = CHANNEL_STATE.participants.length;
            }
          }
        });

        function messageInput() {
          if (event.code == "Enter") {
            sendMessage();
          }
        }

        function sendMessage() {

          const message = document.querySelector("#Chat-Input input").value;

          if (message) {
            document.querySelector("#Chat-Input input").value = "";
            CHANNEL_STATE.messageHandler(new Message(USER_STATE.username, message, new Date(), CHANNEL_STATE));
            if (!USER_STATE.channels.includes(CHANNEL_STATE.name)) { // only for 1st time
              USER_STATE.addChannel(CHANNEL_STATE);
              // CHANNEL_STATE.addUser(USER_STATE.username);
            }
          }
        }

        

      class Message {
        constructor(username, message, timeStamp, channel) {
          this.author = username;
          this.message = message;
          this.hours = timeStamp.getHours();
          this.timeStamp = `${this.hours == 0 ? "12" : ((this.hours % 12) < 10 ? "0" + (this.hours % 12) : (this.hours % 12))}.${timeStamp.getMinutes() < 10 ? "0" + timeStamp.getMinutes() : timeStamp.getMinutes()}${this.hours >= 12 ? 'pm' : 'am'} ${timeStamp.toDateString()}`;
          this.channel = channel.name;
        }
      }

      class User {
        constructor(dateCreated) {
          this.username;
          this.dateCreated = dateCreated;
          this.channels = []; // channel names
        }

        getUsername(unvalidatedUsername) {
          let userHolder = this;

          // Send to server to validate
          let usernameCheck = new Promise((resolve, reject) => {
            socket.emit("new username", unvalidatedUsername);

            // Results
            socket.on("username result", function(result) {
              if (result == "not allowed") {
                reject(new Error("Username used"));
              } else {
                userHolder.username = unvalidatedUsername;
                resolve(unvalidatedUsername);
              }
            });
          });

          return usernameCheck;
        }

        addChannel(channel) {
          if (!this.channels.includes(channel.name)) {
            this.channels.push(channel.name);

            socket.emit("update user", JSON.stringify(this));
          }
        }

        dataUpdate() {
        // Bundle the 3 together
          USER_STATE = this;

          socket.emit("new user", JSON.stringify(USER_STATE));

          // Store user object client side
          localStorage.setItem("user", USER_STATE.username);
        }
      }

      class Channel {
        constructor(name, owner, visibility=true) {
          this.name = name; // Name of channel
          this.owner = owner; // Creator
          this.participants = [];
          this.visibility = visibility;
        }

        addUser(username) {
          this.participants.push(username);
        }
      
        // Handle the viewing of chat details
        showChat(privateFriendChat = false) {
          let channelHolder = this;
          console.log(this.name);
          
          if (privateFriendChat) {
            document.querySelector("#Chat-Name").innerHTML = this.participants.filter(name => name != USER_STATE.username)[1];
          } else {
            document.querySelector("#Chat-Name").innerHTML = this.name + `  <span class="is-size-7 has-text-grey-light">| Members: <button class="is-size-7 has-text-grey-light">${this.participants.length}</button></span>`;

            document.querySelector("#Chat-Name button").addEventListener("click", function(event) {
              console.log(channelHolder.participants, 860);
              let groupMembers = document.querySelector("#Chat-Members section");

              // reset content
              groupMembers.innerHTML = "";

              channelHolder.participants.forEach(function(name) {
                let contactButton = document.createElement("div");
                  contactButton.innerHTML = name + (!(name == USER_STATE.username) ? '<button class="button is-info">Contact</button>' : "");

                  contactButton.addEventListener("click", function(event) {
                    event.preventDefault();

                    // in 1v1 convo names are not important other than to track messages
                    // names are sorted to ensure that both the users will reach same channels everytime
                    let namesSorted = [name, USER_STATE.username].sort();

                    socket.emit("new channel attempt", "%%" + namesSorted[0] + "%%" + namesSorted[1], false);

                    // after user got redirected to a private chat
                    document.querySelector("#Chat-Members").classList.remove("is-active");
                  });
                groupMembers.append(contactButton);
              });

              document.querySelector("#Chat-Members").classList.add("is-active");
            });

            document.querySelector("#Chat-Members button").addEventListener("click", function(event) {
              document.querySelector("#Chat-Members").classList.remove("is-active");
            });
          }

          // Upon showing convo history, set channel as CHANNEL_STATE
          this.dataUpdate();
         
          socket.emit('get messages', this.name);

          socket.on('messages return', messageObjectArray => {
            let today = new Date().getDate();
            if (messageObjectArray) {
              document.querySelector("#Chat-Convo").innerHTML = messageObjectArray
                .map(msg => 
                `<div class="box ${msg.author == USER_STATE.username ? "self-chat" : ""}">
                  <p>${msg.author} <span class="is-size-7 has-text-grey-light">at ${new Date(msg.timeStamp.slice(8)).getDate() == today ? msg.timeStamp.slice(0,7) : msg.timeStamp}</span></p>
                  <div">${unescape(msg.message)}</div>
                </div>`).join("");
             } else {
              document.querySelector("#Chat-Convo").innerHTML = "There is no message to be displayed. Start chatting!";
             }
          });
        }

        showChatList(privateFriendChat = false) {
          // display channel in sidebar
          let li = document.createElement("li");
          let button = document.createElement("button");
          let feed = document.createElement("span");
          
          li.append(button, feed);
          if (privateFriendChat) {
            button.append(this.participants.filter(name => name != USER_STATE.username)[1]);
          } else {
            button.append(this.name);
          }
          let channelHolder = this;

          let counter = {};
          socket.on('message in', messageParcel => {
            if (messageParcel.channel == channelHolder.name && 
                messageParcel.channel != CHANNEL_STATE.name) {
              
              if (counter[messageParcel.channel]) {
                counter[messageParcel.channel]++;
              } else {
                counter[messageParcel.channel] = 1;
              }

              feed.className = "tag is-success";
              feed.innerHTML = counter[messageParcel.channel];
            }
          });

          button.addEventListener("click", function(event) {
            event.preventDefault();
            console.log("button click", 505);

            channelHolder.showChat(privateFriendChat);

            counter[channelHolder.name] = 0;
            feed.className = "";
            feed.innerHTML = "";
          });

          return li;
        }

        messageHandler(msgObj) {
          msgObj["message"] = escape(msgObj["message"]);
          socket.emit("message out", msgObj);
        }

        dataUpdate() {
        // Bundle the 3 together
          if (CHANNEL_STATE != this) {
            CHANNEL_STATE = this;

            // Store user object client side
            localStorage.setItem("channel", CHANNEL_STATE.name);
            console.log(localStorage.getItem("channel"), 527);
          }
        }
      }

      // JSON convertor to User Objects
      function userJSONConvert(userParcel) {
        if (userParcel) {
          if (typeof userParcel == "string") {
            userParcel = JSON.parse(userParcel);
          }
          let returnedUser = new User(userParcel.dateCreated);
          returnedUser.username = userParcel.username;
          returnedUser.channels = userParcel.channels || {}; // blank object will be converted to undefined
          return returnedUser;
        } else {
          return userParcel;
        }
      }

      // JSON convertor to Channel Objects
      function channelJSONConvert(objParcel) {
        if (typeof objParcel == "string") {
          objParcel = JSON.parse(objParcel);
        }
        let returnedChannel = new Channel(objParcel.name, objParcel.owner, objParcel.visibility);
        returnedChannel.participants = objParcel.participants;

        return returnedChannel;
      }

      // Always return a username string
      function UsernameWarning(toggle, status="") {
        const warningText = document.querySelector("#Index-PopUp .help");
        const warningBlock = document.querySelector("#Index-PopUp input");

        warningManager(warningBlock, warningText, toggle, status);
      }

      function SearchBarWarning(toggle, status="") {
        const searchBar = document.querySelector("#Menu-Channels .input");
        const searchWarning = document.querySelector("#Menu-Channels p");

        warningManager(searchBar, searchWarning, toggle, status);
      }

      function warningManager(warningNode, warningText, toggle, status) {
        // Clean up prior errors
        warningNode.classList.remove("is-danger");
        warningText.textContent = "";

        if (toggle) {
          warningNode.classList.add("is-danger");
        } else {
          // turn off the warning
          warningNode.classList.remove("is-danger");
        }
        warningText.textContent = status;
      }

      function usernameModalManager(user) {
        const usernameModal = document.querySelector("#Template-Modal").innerHTML;
      
        // Force pop up
        document.querySelector("main").innerHTML += usernameModal;

        // get unvalidated username
        document.querySelector("#Index-PopUp button")
          .addEventListener("click", function(event) {
            event.preventDefault();

            modalHandler(user);
          }
        );

        document.querySelector("#Index-PopUp input")
          .addEventListener("keyup", function(event) {
            event.preventDefault();
            if (event.code == "Enter") {
              modalHandler(user);
            }
          }
        );

        function modalHandler(user) {
          // Remove prior errors if any
          UsernameWarning(false);

          // retrieve raw value
          const unvalidatedUsername = document.querySelector("#Index-PopUp input").value;
          
          // Client side validation
          if (!unvalidatedUsername) {
            UsernameWarning(true, "Please enter a valid name");

          } else {
            // pass the username to User Object to validate with server
            let serverValidateResult = new Promise((resolve, reject) => 
              resolve(user.getUsername(unvalidatedUsername)));
          
            serverValidateResult.then(validatedUsername => {

              document.querySelector("#Index-PopUp").classList.remove("is-active");

              // update data and sync to server
              user.dataUpdate();

              document.querySelector("#Layout-Greeting").innerHTML = 
                templateFn({"comment": `Hi, ${validatedUsername}`});

              return;
              })
            .catch(error => UsernameWarning(true, error ||"Please refresh the page and try again!"));
          }
        }
      }

    </script>


{% endblock %}

  

  
