{% extends "layout.html" %}

{% block title %}
  Hello World!
{% endblock %}

{% block content %}
  <style>
    section {
      height: calc(100vh - 52px);
      display: grid;
      grid-template-columns: minmax(200px, 1fr) 4fr;
    }
    aside {
      background-color: #abcdef;
      padding: 20px;
    }

    .menu-list button {
      background-color: transparent;
      border: none;
    }
    .menu-list button:hover {
      cursor: pointer;
    }

    #Menu-search-bar {
      padding: 8px 4px 8px 16px;
      margin-bottom: 0px;
    }

    .menu-input > .level-left {
      flex-grow: 1;
      flex-shrink: 1;
    }

    .menu-input .level-item {
      justify-content: flex-start;
      flex-grow: 1;
      flex-shrink: 1;
    }

    .menu-input input {
      border: none;
      width: 100%;
    }

    .menu-input button.is-rounded {
      height: 35px;
      width: 35px;
      padding: .1em .12em .1em .08em;
    }

    #Menu-search-bar button {
      padding: .5em;
      color: #9f9f9f;
    }

    #Menu-search-bar button:hover {
      background-color: transparent;
      color: #262626;
    }

    main {
      padding: 1em;
      height: inherit;
      background-color: #eee;
      display: flex; 
      flex-direction: column;
      align-items: stretch;
    }

    #Chat-Input {
      padding-right: .5em;
      margin: .5em 0;
    }

    #Chat-Send {
      padding: .5em .8em .5em .6em;
      font-size: 14px;
      margin-left: .25em;
    }

    #Chat-Name, #Chat-Input {
      min-height: 50px;
    }
    #Chat-Convo {
      flex-grow: 1;
      background-color: #ddd;
      /* overflow-y: scroll; */
    }

    @media screen and (max-width: 768px) {
      .level-left+.level-right {
        margin-top: 0rem;
      }
    }

    @media screen and (max-width: 600px) {
      section {
        grid-template-columns: 5fr;
      }
      aside {
        display:none;
      }
    }


  </style>

<section>
  <!-- Channel Aside -->
  <aside class="menu">
    <!-- Search Bar -->
    <p class="menu-label">
      Channels
    </p>
    <ul class="menu-list" id="Menu-Channels">
      <li>
        <div class="input is-rounded level menu-input" id="Menu-search-bar">
          <div class="control is-expanded level-left">
            <div class="level-item">
              <input type="text" placeholder="Search or create channel" id="Menu-search-value">
            </div>
          </div>
          <div class="control level-right">
            <div class="level-item">
              <button id="Menu-search-Add">
                <i class="fas fa-plus"></i>
              </button>
              <button id="Menu-search-Search">
                <i class="fas fa-search"></i>
              </button>
            </div>
          </div>
        </div>
        <p class="help is-danger"></p>
      </li> 
    </ul>
    <hr>
    <!-- My channels -->
    <p class="menu-label">
      My Channels
    </p>
    <ul class="menu-list">
      <div id="Menu-Channels-List"></div>
      <div id="Menu-My-Channels-List">

      </div>  
    </ul>
    <p class="menu-label">
      Friends
    </p>
  </aside>
  <main>
    <!-- Main channel or last channel -->
    <div id="Chat-Name"></div>
    <div id="Chat-Convo"></div>
    <div id="Chat-Input" class="input is-rounded level menu-input">
      <div class="control is-expanded level-left">
        <div class="level-item">
          <input type="text" placeholder="Say something here!">
        </div>
      </div>
      <div class="control level-right">
        <div class="level-item">
          <button class="button is-rounded is-info">
              <i class="far fa-smile"></i>
          </button>
          <button class="button is-rounded is-info" id="Chat-Send">
              <i class="fas fa-paper-plane"></i>
          </button>
        </div>
      </div>
    </div>
  </main>
</section>
  
<script id="Template-Username" type="text/x-lodash-template">
  <div>
    <%= comment %>
  </div>
</script>

  <script id="Template-Modal" type="text/x-lodash-template">
    <div class="modal is-active" id="Index-PopUp">
      <div class="modal-background"></div>  
      <div class="modal-content">

        <div class="box">
          <article class="media">
            <div class="media-content">
              <div class="content">

                <p class="title is-3">Welcome to ChatRoom!</p>
                <p class="subtitle is-5">First time here? Enter username below to begin!</p>

                <div class="field">
                  <label class="label">Name</label>
                  <div class="control has-icons-left has-icons-right">
                    <input class="input" type="text" placeholder="Username">
                    <span class="icon is-small is-left">
                      <i class="fas fa-user"></i>
                    </span>
                    <p class="help is-danger"></p>
                  </div>
                </div>

                <div class="buttons is-right">
                  <div class="control">
                    <button class="button is-link">Submit</button>
                  </div>
                </div>

              </div>
            </div>
          </article>
        </div>

      </div>
    </div>
  </script>

  <script>
      // The app will store the userNAME into localStorage
      // Upon running, the app will retrieve user details from server
        // AND STORE USER OBJECT into USER_STATE
        // to keep memory in sync

      const templateFn = _.template(document.querySelector("#Template-Username").innerHTML);
      const channelContainer = document.querySelector("#Menu-Channels");
      const channelHead = document.querySelector("#Chat-Name");
      const channelConvo = document.querySelector("#Chat-Convo");

      const ChannelList = document.querySelector("#Menu-Channels-List");
      const MyChannelList = document.querySelector("#Menu-My-Channels-List");
      
      // https://cs50.harvard.edu/web/notes/5/
      const socket = io.connect(location.protocol + '//' + document.domain + ':' + location.port);

      document.addEventListener("DOMContentLoaded", function() {
      // USER VALIDATION
        // Returned users to be greeted
        if (storedUSERNAME) {
          // get User Object from server
          socket.emit("get user", storedUSERNAME);

          // server response
          socket.on("return user", userObj => {
            // Fallback in case of server problems
            if (userObj == "error") {
              // Promise
              usernameModalManager(new User(new Date()));
                    
            } else {
              // Return userObj successful
              USER_STATE = userJSONConvert(userObj);

              document.querySelector("#Layout-Greeting").innerHTML = 
                templateFn({"comment": `Welcome back, ${USER_STATE.username}`});
            }
          });
        } else {
          // If first time, get unique username

          // new User Object
          // Promise passed here to update data
          usernameModalManager(new User(new Date()));
        }
          
        // Append the channel to aside bar
        if (myChannels = USER_STATE.channels) {
          socket.emit("get channel", )
          myChannels.forEach(channel => 
            MyChannelList.append(
              channelJSONConvert(channel).showChatList()
            )
          );
        } else {
          let helpfulMsg = document.createElement("li");
          helpfulMsg.append("Search for channels above to get involved!");

          MyChannelList.append(helpfulMsg);
        }

      });
       
        
      // Channel Functionalities

        // Create Channel
        const createChannel = document.querySelector("#Menu-search-Add");
        const searchChannel = document.querySelector("#Menu-search-Search");
        let searchBarValue;

        createChannel.addEventListener("click", function(event){
          event.preventDefault();

          searchBarValue = document.querySelector("#Menu-search-value").value;

          if (searchBarValue) {
            // Check whether channel name used
            socket.emit("new channel name", searchBarValue); // Raw unvalidated string
          }
        });

        socket.on("Channel attempt", channelCreateResult => {
          if (channelCreateResult) {
            channel = new Channel(searchBarValue, USER_STATE.username);
            CHANNEL_STATE = channel;
            socket.emit("new channel", JSON.stringify(channel), channel.name);  

            ChannelList.append(channel.showChatList());

            channel.showChat();

            // set channel as last upon creation
            USER_STATE.addChannel(channel);
            localStorage.setItem("channel", JSON.stringify(channel));
            localStorage.setItem("user", JSON.stringify(USER_STATE));
          }
        });

        // Search channels
        searchChannel.addEventListener("click", function(event){
          event.preventDefault();

          searchBarValue = document.querySelector("#Menu-search-value").value;

          // Get all channels if no search string
          socket.emit("search channels", searchBarValue); // Search String
        });

        socket.on("search channels results", channelSearchResult => {
          channelSearchResult.forEach(channelSearchItem => 
            ChannelList.append(channelJSONConvert(channelSearchItem).showChatList()))
        });

      // Messaging Functionalities
      
        // Message in
        socket.on('message in', (messageParcel, room) => {
          messageParcel = JSON.parse(messageParcel);
          CHANNEL_STATE.showChat();
        });

        // Message out
        document.querySelector('#Chat-Send').addEventListener("click", function(event) {
          event.preventDefault();
          const message = document.querySelector("#Chat-Input input").value;

          if (message) {
            CHANNEL_STATE.messageHandler(new Message(USER_STATE.username, message, new Date()));           
          }
        });

      class Message {
        constructor(username, message, timeStamp) {
          this.author = username;
          this.message = message;
          this.timeStamp = timeStamp;
        }
      }

      class User {
        constructor(dateCreated) {
          this.username;
          this.dateCreated = dateCreated;
          this.channels = []; // channel names
        }

        getUsername(unvalidatedUsername) {
          // Send to server to validate
          let usernameCheck = new Promise(resolve => {
            socket.emit("new username", unvalidatedUsername);

            // Results
            socket.on("username result", function(result) {
              if (result == "not allowed") {
                resolve("Username used");
              } else {
                this.username = unvalidatedUsername;
                resolve(false);
              }
            });
          });

          return usernameCheck;
        }

        addChannel(channelObj) {
          this.channels.push(channelObj.name);
        }

        removeChannel(channelObj) {
          
        }
      }

      class Channel {
        constructor(name, owner) {
          this.participants = []; // open for anyone, handled by participantAdd
          this.name = name; // Name of channel
          this.owner = owner; // Creator
        }
      
        // Handle the viewing of chat details
        showChat() {
          socket.emit('get messages', this.name);

          channelHead.textContent = this.name;

          socket.on('message results', messageObjectArray =>
            channelConvo.innerHTML = messageObjectArray
              .map(msg => 
              `<div>
                <p>${msg.author} at ${msg.timeStamp}</p>
                <div>${msg.message}</div>
              </div>`).join("") || "There is no message to be displayed. Start chatting!"
          );
        }

        showChatList() {
          let li = document.createElement("li");
          let button = document.createElement("button");
          li.append(button);
          button.append(this.name);
          let channelHolder = this;

          button.addEventListener("click", function(event) {
            event.preventDefault();

            channelHolder.showChat();
            CHANNEL_STATE = channelHolder;

            // set channel as last upon click
            localStorage.setItem("channel", JSON.stringify(channelHolder));
          });

          return li;
        }
      }

      // JSON convertor to User Objects
      function userJSONConvert(userParcel) {
        if (userParcel) {
          if (typeof userParcel == "string") {
            userParcel = JSON.parse(userParcel);
          }
          let returnedUser = new User(userParcel.dateCreated);
          returnedUser.username = userParcel.username;
          returnedUser.channels = userParcel.channels || {}; // blank object will be converted to undefined
          return returnedUser;
        } else {
          return userParcel;
        }
      }

      // JSON convertor to Channel Objects
      function channelJSONConvert(objParcel) {
        if (typeof objParcel == "string") {
          objParcel = JSON.parse(objParcel);
        }
        let returnedChannel = new Channel(objParcel.name, objParcel.owner);
        returnedChannel.history = objParcel.history;
        returnedChannel.participants = objParcel.participants;

        return returnedChannel;
      }

      // Always return a username string
      function UsernameWarning(toggle, status="") {
        const warningText = document.querySelector("#Index-PopUp .help");
        const warningBlock = document.querySelector("#Index-PopUp input");

          // Clean up prior errors
        warningBlock.classList.remove("is-danger");
        warningText.textContent = "";

        if (toggle) {
          warningBlock.classList.add("is-danger");
        } else {
          // turn off the warning
          warningBlock.classList.remove("is-danger");
        }
        warningText.textContent = status;
      }

      function usernameModalManager(userObject) {
        const usernameModal = document.querySelector("#Template-Modal").innerHTML;
      
        // Force pop up
        document.querySelector("main").innerHTML += usernameModal;

        // get unvalidated username
        document.querySelector("#Index-PopUp button")
          .addEventListener("click", function(event) {
            event.preventDefault();

            // Remove prior errors if any
            UsernameWarning(false);

            // retrieve raw value
            const unvalidatedUsername = document.querySelector("#Index-PopUp input").value;
            
            // Client side validation
            if (!unvalidatedUsername) {
              UsernameWarning(true, "Please enter a valid name");

            } else {
              // pass the username to User Object to validate with server
              let serverValidateResult = new Promise((resolve, reject) => {
                resolve(userObject.getUsername(unvalidatedUsername))});
            
              serverValidateResult.then(result => {
                if (result) {
                  UsernameWarning(true, result);
                } else {
                  // Success
                  document.querySelector("#Index-PopUp").classList.remove("is-active");
                  return unvalidatedUsername;
                }})
              .then(validatedUsername => {
                
                // update data
                dataUpdate(validatedUsername, userObject);

                document.querySelector("#Layout-Greeting").innerHTML = 
                  templateFn({"comment": `Hi, ${validatedUsername}`});
                })
              .catch(error => UsernameWarning(true, "Please refresh the page and try again!"));
            }
          }
        );
      }

      function dataUpdate(nameToBeSaved, userObject) {
      // Bundle the 3 together
        // new User Object
        userObject.username = nameToBeSaved;
        USER_STATE = userObject;
     

        socket.emit("new user", JSON.stringify(USER_STATE));

        // Store user object client side
        localStorage.setItem("user", nameToBeSaved);
      }

    </script>


{% endblock %}

  

  
